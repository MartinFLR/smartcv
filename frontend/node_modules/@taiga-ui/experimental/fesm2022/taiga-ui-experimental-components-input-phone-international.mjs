import { NgForOf, NgIf } from '@angular/common';
import * as i0 from '@angular/core';
import { inject, signal, computed, effect, ElementRef, Component, ViewEncapsulation, ChangeDetectionStrategy, ViewChildren, Input, Output } from '@angular/core';
import { toSignal, takeUntilDestroyed, toObservable } from '@angular/core/rxjs-interop';
import * as i3 from '@angular/forms';
import { FormsModule } from '@angular/forms';
import * as i1 from '@maskito/angular';
import { MaskitoDirective } from '@maskito/angular';
import { maskitoTransform, MASKITO_DEFAULT_OPTIONS, maskitoInitialCalibrationPlugin } from '@maskito/core';
import { maskitoPhoneOptionsGenerator, maskitoGetCountryFromNumber } from '@maskito/phone';
import { TuiControl, tuiAsControl } from '@taiga-ui/cdk/classes';
import { EMPTY_QUERY, TUI_ALLOW_SIGNAL_WRITES, TUI_DEFAULT_MATCHER, CHAR_PLUS } from '@taiga-ui/cdk/constants';
import { TuiActiveZone } from '@taiga-ui/cdk/directives/active-zone';
import { tuiAutoFocusOptionsProvider, TuiAutoFocus } from '@taiga-ui/cdk/directives/auto-focus';
import { TUI_IS_IOS, tuiFallbackValueProvider } from '@taiga-ui/cdk/tokens';
import { tuiInjectElement, tuiValue, tuiIsInputEvent } from '@taiga-ui/cdk/utils/dom';
import { tuiDirectiveBinding } from '@taiga-ui/cdk/utils/miscellaneous';
import { TuiButton } from '@taiga-ui/core/components/button';
import * as i4 from '@taiga-ui/core/components/data-list';
import { TuiOptionNew, TuiDataList } from '@taiga-ui/core/components/data-list';
import * as i2 from '@taiga-ui/core/components/textfield';
import { TUI_TEXTFIELD_OPTIONS, TuiTextfieldContent, TuiTextfield, TuiWithTextfield } from '@taiga-ui/core/components/textfield';
import { tuiDropdownOpen, TuiDropdownOpen } from '@taiga-ui/core/directives/dropdown';
import { TuiTitle } from '@taiga-ui/core/directives/title';
import { TuiFlagPipe } from '@taiga-ui/core/pipes';
import { TUI_COMMON_ICONS } from '@taiga-ui/core/tokens';
import { TUI_INPUT_PHONE_INTERNATIONAL_OPTIONS } from '@taiga-ui/kit/components/input-phone-international';
import { TuiChevron } from '@taiga-ui/kit/directives/chevron';
import { TUI_INTERNATIONAL_SEARCH, TUI_COUNTRIES } from '@taiga-ui/kit/tokens';
import { tuiMaskito, tuiGetCallingCode } from '@taiga-ui/kit/utils';
import { TuiCell } from '@taiga-ui/layout/components/cell';
import { validatePhoneNumberLength } from 'libphonenumber-js';
import { from, filter, skip } from 'rxjs';

const NOT_FORM_CONTROL_SYMBOLS = /[^+\d]/g;
class TuiInputPhoneInternational extends TuiControl {
    constructor() {
        super(...arguments);
        this.list = EMPTY_QUERY;
        this.el = tuiInjectElement();
        this.ios = inject(TUI_IS_IOS);
        this.icons = inject(TUI_COMMON_ICONS);
        this.options = inject(TUI_INPUT_PHONE_INTERNATIONAL_OPTIONS);
        this.countries = signal(this.options.countries);
        this.code = signal(this.options.countryIsoCode);
        this.label = toSignal(inject(TUI_INTERNATIONAL_SEARCH));
        this.metadata = toSignal(from(this.options.metadata));
        this.names = toSignal(inject(TUI_COUNTRIES));
        this.open = tuiDropdownOpen();
        this.search = signal('');
        this.size = inject(TUI_TEXTFIELD_OPTIONS).size;
        this.mask = tuiMaskito(computed(() => this.computeMask(this.code(), this.metadata())));
        this.masked = tuiValue(this.el);
        this.valueChangeEffect = effect(() => {
            this.onChange(this.unmask(this.masked()));
        }, TUI_ALLOW_SIGNAL_WRITES);
        this.filtered = computed(() => this.countries()
            .map((iso) => ({
            iso,
            name: this.names()?.[iso] || '',
            code: tuiGetCallingCode(iso, this.metadata()),
        }))
            .filter(({ name, code }) => TUI_DEFAULT_MATCHER(name + code, this.search())));
        this.enabled = tuiDirectiveBinding(TuiDropdownOpen, 'tuiDropdownEnabled', this.interactive, {});
        this.$ = inject(TuiActiveZone)
            .tuiActiveZoneChange.pipe(filter(() => !this.readOnly()), takeUntilDestroyed())
            .subscribe((active) => {
            const prefix = `${tuiGetCallingCode(this.code(), this.metadata())} `;
            this.search.set('');
            this.masked.update((value) => {
                const fallback = active ? value || prefix : value;
                return value === prefix ? '' : fallback;
            });
        });
        this.countrySearch = false;
        this.countryIsoCodeChange = toObservable(this.code).pipe(skip(1));
    }
    set countriesValue(value) {
        this.countries.set(value);
    }
    set isoCode(code) {
        this.code.set(code);
    }
    writeValue(unmasked) {
        const code = this.getCountryCode(unmasked ?? '');
        if (code) {
            this.code.set(code);
        }
        super.writeValue(unmasked);
        this.masked.set(maskitoTransform(this.value() ?? '', this.mask() || MASKITO_DEFAULT_OPTIONS));
    }
    onPaste(event) {
        const data = tuiIsInputEvent(event) && event.data;
        if (!data ||
            (!event.inputType.includes('Drop') && !event.inputType.includes('Paste'))) {
            return;
        }
        const code = this.getCountryCode(data);
        if (code) {
            this.code.set(code);
        }
    }
    onItemClick(code) {
        this.el.focus();
        this.open.set(false);
        this.code.set(code);
        this.search.set('');
        this.masked.set(maskitoTransform(this.value() || tuiGetCallingCode(code, this.metadata()), this.mask() || MASKITO_DEFAULT_OPTIONS));
    }
    computeMask(countryIsoCode, metadata) {
        if (!metadata) {
            return null;
        }
        const { plugins, ...options } = maskitoPhoneOptionsGenerator({
            countryIsoCode,
            metadata,
            separator: this.options.separator,
        });
        return {
            ...options,
            plugins: [...plugins, maskitoInitialCalibrationPlugin()],
        };
    }
    unmask(maskedValue) {
        const value = maskedValue.replaceAll(NOT_FORM_CONTROL_SYMBOLS, '');
        return value === tuiGetCallingCode(this.code(), this.metadata()) ? '' : value;
    }
    getCountryCode(value) {
        const metadata = this.metadata();
        const phone = value.startsWith(CHAR_PLUS) ? value : CHAR_PLUS + value;
        return metadata && validatePhoneNumberLength(phone) !== 'TOO_SHORT'
            ? (maskitoGetCountryFromNumber(phone, metadata) ?? null)
            : null;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputPhoneInternational, deps: null, target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiInputPhoneInternational, isStandalone: true, selector: "input[tuiInputPhoneInternational]", inputs: { countrySearch: "countrySearch", countriesValue: ["countries", "countriesValue"], isoCode: ["countryIsoCode", "isoCode"] }, outputs: { countryIsoCodeChange: "countryIsoCodeChange" }, host: { attributes: { "type": "tel", "ngSkipHydration": "true" }, listeners: { "input": "masked.set($event.target.value)", "click": "open.set(false)", "beforeinput.capture": "onPaste($event)" }, properties: { "attr.inputmode": "!ios && open() ? \"none\" : null", "disabled": "disabled()" } }, providers: [
            tuiAsControl(TuiInputPhoneInternational),
            tuiFallbackValueProvider(''),
            tuiAutoFocusOptionsProvider({ preventScroll: true }),
        ], viewQueries: [{ propertyName: "list", predicate: TuiOptionNew, descendants: true, read: ElementRef }], usesInheritance: true, hostDirectives: [{ directive: i1.MaskitoDirective }, { directive: i2.TuiWithTextfield }], ngImport: i0, template: "<ng-container *tuiTextfieldContent>\n    <button\n        appearance=\"textfield\"\n        tabindex=\"-1\"\n        tuiButton\n        tuiChevron\n        type=\"button\"\n        class=\"t-ipi-select\"\n        [attr.data-mode]=\"mode()\"\n        [class.t-ipi-select_readonly]=\"readOnly()\"\n        [disabled]=\"disabled()\"\n        [size]=\"size()\"\n        [tuiAppearanceFocus]=\"open()\"\n        (pointerdown.prevent)=\"interactive() && open.set(!open())\"\n    >\n        <img\n            class=\"t-ipi-flag\"\n            [alt]=\"names()?.[code()]\"\n            [class.t-ipi-flag_small]=\"size() === 's'\"\n            [src]=\"code() | tuiFlag\"\n        />\n    </button>\n</ng-container>\n<ng-container *tuiTextfieldDropdown>\n    <div\n        *ngIf=\"countrySearch\"\n        #element\n        class=\"t-ipi-search\"\n    >\n        <tui-textfield\n            [iconStart]=\"icons.search\"\n            [tuiTextfieldSize]=\"size() === 's' ? 's' : 'm'\"\n        >\n            <input\n                autocomplete=\"off\"\n                tuiTextfield\n                type=\"text\"\n                [focused]=\"true\"\n                [ngModel]=\"search()\"\n                [ngModelOptions]=\"{standalone: true}\"\n                [placeholder]=\"label()\"\n                [tuiAutoFocus]=\"!!element.closest('tui-dropdown-mobile')\"\n                (keydown.arrowDown)=\"list.get(0)?.nativeElement?.focus()\"\n                (ngModelChange)=\"search.set($event)\"\n            />\n        </tui-textfield>\n    </div>\n\n    <tui-data-list class=\"t-ipi-options\">\n        <button\n            *ngFor=\"let item of filtered()\"\n            new\n            tuiOption\n            type=\"button\"\n            [tuiCell]=\"size()\"\n            (click)=\"onItemClick(item.iso)\"\n        >\n            <img\n                alt=\"\"\n                class=\"t-ipi-flag\"\n                [class.t-ipi-flag_small]=\"size() === 's'\"\n                [src]=\"item.iso | tuiFlag\"\n            />\n            <span tuiTitle>{{ item.name }}</span>\n            <span class=\"t-ipi-code\">{{ item.code }}</span>\n        </button>\n    </tui-data-list>\n</ng-container>\n", styles: ["[tuiInputPhoneInternational][tuiInputPhoneInternational]{left:var(--t-offset);border-top-left-radius:0;border-bottom-left-radius:0;inline-size:calc(100% - var(--t-offset))}tui-root:has(tui-dropdown-mobile) [tuiInputPhoneInternational][tuiInputPhoneInternational]{caret-color:transparent}[tuiInputPhoneInternational][tuiInputPhoneInternational]+label{padding-inline-start:var(--t-offset)}tui-textfield[data-size=s]{--t-offset: 4.125rem}tui-textfield[data-size=s] .t-ipi-flag{margin:0 .1875rem}tui-textfield[data-size=m]{--t-offset: 4.875rem}tui-textfield[data-size=m] .t-ipi-flag{margin:0 -.1875rem}tui-textfield[data-size=l]{--t-offset: 5.25rem}tui-textfield[data-size=l] .t-ipi-flag{margin:0 -.1875rem}tui-textfield .t-ipi-select{position:absolute;left:0;border-radius:inherit;border-top-right-radius:0;border-bottom-right-radius:0}tui-textfield .t-ipi-select_readonly{pointer-events:none}.t-ipi-flag{inline-size:1.75rem;block-size:1.75rem;border-radius:100%}.t-ipi-flag_small{inline-size:1.25rem;block-size:1.25rem}.t-ipi-code{color:var(--tui-text-secondary)}.t-ipi-search{position:sticky;top:0;z-index:1;background:var(--tui-background-elevation-3);padding:.375rem .375rem 0}@supports (-webkit-touch-callout: none){.t-ipi-search input:focus{animation:tuiPreventIOSScroll 1ms}}@keyframes tuiPreventIOSScroll{0%{opacity:0}to{opacity:1}}tui-dropdown-mobile .t-ipi-search{background:var(--tui-background-elevation-1)}tui-dropdown-mobile .t-ipi-options:not(:first-child){min-block-size:calc(100 * var(--tui-viewport-vh) - 8.75rem)}\n"], dependencies: [{ kind: "ngmodule", type: FormsModule }, { kind: "directive", type: i3.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i3.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i3.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "directive", type: NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: TuiAutoFocus, selector: "[tuiAutoFocus]", inputs: ["tuiAutoFocus"] }, { kind: "directive", type: TuiButton, selector: "a[tuiButton],button[tuiButton],a[tuiIconButton],button[tuiIconButton]", inputs: ["size"] }, { kind: "directive", type: TuiCell, selector: "[tuiCell]:not(ng-template)", inputs: ["tuiCell", "tuiCellHeight"] }, { kind: "directive", type: TuiChevron, selector: "[tuiChevron]", inputs: ["tuiChevron"] }, { kind: "component", type: i4.TuiDataListComponent, selector: "tui-data-list", inputs: ["emptyContent", "size"] }, { kind: "directive", type: i4.TuiOptionNew, selector: "button[tuiOption][new], a[tuiOption][new], label[tuiOption][new]", inputs: ["disabled"] }, { kind: "pipe", type: TuiFlagPipe, name: "tuiFlag" }, { kind: "component", type: i2.TuiTextfieldComponent, selector: "tui-textfield:not([multi])" }, { kind: "directive", type: i2.TuiTextfieldDirective, selector: "input[tuiTextfield]:not([tuiInputCard]):not([tuiInputExpire]):not([tuiInputCVC])" }, { kind: "directive", type: i2.TuiTextfieldOptionsDirective, selector: "[tuiTextfieldAppearance],[tuiTextfieldSize],[tuiTextfieldCleaner]", inputs: ["tuiTextfieldAppearance", "tuiTextfieldSize", "tuiTextfieldCleaner"] }, { kind: "directive", type: i2.TuiTextfieldDropdownDirective, selector: "ng-template[tuiTextfieldDropdown]" }, { kind: "directive", type: TuiTextfieldContent, selector: "ng-template[tuiTextfieldContent]" }, { kind: "directive", type: TuiTitle, selector: "[tuiTitle]", inputs: ["tuiTitle"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputPhoneInternational, decorators: [{
            type: Component,
            args: [{ standalone: true, selector: 'input[tuiInputPhoneInternational]', imports: [
                        FormsModule,
                        NgForOf,
                        NgIf,
                        TuiAutoFocus,
                        TuiButton,
                        TuiCell,
                        TuiChevron,
                        TuiDataList,
                        TuiFlagPipe,
                        TuiTextfield,
                        TuiTextfieldContent,
                        TuiTitle,
                    ], encapsulation: ViewEncapsulation.None, changeDetection: ChangeDetectionStrategy.OnPush, providers: [
                        tuiAsControl(TuiInputPhoneInternational),
                        tuiFallbackValueProvider(''),
                        tuiAutoFocusOptionsProvider({ preventScroll: true }),
                    ], hostDirectives: [MaskitoDirective, TuiWithTextfield], host: {
                        type: 'tel',
                        ngSkipHydration: 'true',
                        '[attr.inputmode]': '!ios && open() ? "none" : null',
                        '[disabled]': 'disabled()',
                        '(input)': 'masked.set($event.target.value)',
                        '(click)': 'open.set(false)',
                        '(beforeinput.capture)': 'onPaste($event)',
                    }, template: "<ng-container *tuiTextfieldContent>\n    <button\n        appearance=\"textfield\"\n        tabindex=\"-1\"\n        tuiButton\n        tuiChevron\n        type=\"button\"\n        class=\"t-ipi-select\"\n        [attr.data-mode]=\"mode()\"\n        [class.t-ipi-select_readonly]=\"readOnly()\"\n        [disabled]=\"disabled()\"\n        [size]=\"size()\"\n        [tuiAppearanceFocus]=\"open()\"\n        (pointerdown.prevent)=\"interactive() && open.set(!open())\"\n    >\n        <img\n            class=\"t-ipi-flag\"\n            [alt]=\"names()?.[code()]\"\n            [class.t-ipi-flag_small]=\"size() === 's'\"\n            [src]=\"code() | tuiFlag\"\n        />\n    </button>\n</ng-container>\n<ng-container *tuiTextfieldDropdown>\n    <div\n        *ngIf=\"countrySearch\"\n        #element\n        class=\"t-ipi-search\"\n    >\n        <tui-textfield\n            [iconStart]=\"icons.search\"\n            [tuiTextfieldSize]=\"size() === 's' ? 's' : 'm'\"\n        >\n            <input\n                autocomplete=\"off\"\n                tuiTextfield\n                type=\"text\"\n                [focused]=\"true\"\n                [ngModel]=\"search()\"\n                [ngModelOptions]=\"{standalone: true}\"\n                [placeholder]=\"label()\"\n                [tuiAutoFocus]=\"!!element.closest('tui-dropdown-mobile')\"\n                (keydown.arrowDown)=\"list.get(0)?.nativeElement?.focus()\"\n                (ngModelChange)=\"search.set($event)\"\n            />\n        </tui-textfield>\n    </div>\n\n    <tui-data-list class=\"t-ipi-options\">\n        <button\n            *ngFor=\"let item of filtered()\"\n            new\n            tuiOption\n            type=\"button\"\n            [tuiCell]=\"size()\"\n            (click)=\"onItemClick(item.iso)\"\n        >\n            <img\n                alt=\"\"\n                class=\"t-ipi-flag\"\n                [class.t-ipi-flag_small]=\"size() === 's'\"\n                [src]=\"item.iso | tuiFlag\"\n            />\n            <span tuiTitle>{{ item.name }}</span>\n            <span class=\"t-ipi-code\">{{ item.code }}</span>\n        </button>\n    </tui-data-list>\n</ng-container>\n", styles: ["[tuiInputPhoneInternational][tuiInputPhoneInternational]{left:var(--t-offset);border-top-left-radius:0;border-bottom-left-radius:0;inline-size:calc(100% - var(--t-offset))}tui-root:has(tui-dropdown-mobile) [tuiInputPhoneInternational][tuiInputPhoneInternational]{caret-color:transparent}[tuiInputPhoneInternational][tuiInputPhoneInternational]+label{padding-inline-start:var(--t-offset)}tui-textfield[data-size=s]{--t-offset: 4.125rem}tui-textfield[data-size=s] .t-ipi-flag{margin:0 .1875rem}tui-textfield[data-size=m]{--t-offset: 4.875rem}tui-textfield[data-size=m] .t-ipi-flag{margin:0 -.1875rem}tui-textfield[data-size=l]{--t-offset: 5.25rem}tui-textfield[data-size=l] .t-ipi-flag{margin:0 -.1875rem}tui-textfield .t-ipi-select{position:absolute;left:0;border-radius:inherit;border-top-right-radius:0;border-bottom-right-radius:0}tui-textfield .t-ipi-select_readonly{pointer-events:none}.t-ipi-flag{inline-size:1.75rem;block-size:1.75rem;border-radius:100%}.t-ipi-flag_small{inline-size:1.25rem;block-size:1.25rem}.t-ipi-code{color:var(--tui-text-secondary)}.t-ipi-search{position:sticky;top:0;z-index:1;background:var(--tui-background-elevation-3);padding:.375rem .375rem 0}@supports (-webkit-touch-callout: none){.t-ipi-search input:focus{animation:tuiPreventIOSScroll 1ms}}@keyframes tuiPreventIOSScroll{0%{opacity:0}to{opacity:1}}tui-dropdown-mobile .t-ipi-search{background:var(--tui-background-elevation-1)}tui-dropdown-mobile .t-ipi-options:not(:first-child){min-block-size:calc(100 * var(--tui-viewport-vh) - 8.75rem)}\n"] }]
        }], propDecorators: { list: [{
                type: ViewChildren,
                args: [TuiOptionNew, { read: ElementRef }]
            }], countrySearch: [{
                type: Input
            }], countryIsoCodeChange: [{
                type: Output
            }], countriesValue: [{
                type: Input,
                args: ['countries']
            }], isoCode: [{
                type: Input,
                args: ['countryIsoCode']
            }] } });

/**
 * Generated bundle index. Do not edit.
 */

export { TuiInputPhoneInternational };
//# sourceMappingURL=taiga-ui-experimental-components-input-phone-international.mjs.map
