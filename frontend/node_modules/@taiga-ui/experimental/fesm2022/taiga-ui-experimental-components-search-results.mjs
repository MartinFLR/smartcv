import { NgForOf, NgIf, KeyValuePipe, NgTemplateOutlet } from '@angular/common';
import * as i0 from '@angular/core';
import { inject, Component, ChangeDetectionStrategy, Input, Directive, TemplateRef, ContentChild } from '@angular/core';
import { toSignal, takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { NgControl } from '@angular/forms';
import { WA_LOCAL_STORAGE, WA_NAVIGATOR } from '@ng-web-apis/common';
import { TuiButton } from '@taiga-ui/core/components/button';
import { TuiTextfieldComponent } from '@taiga-ui/core/components/textfield';
import { TuiTitle } from '@taiga-ui/core/directives/title';
import { TUI_CLOSE_WORD } from '@taiga-ui/core/tokens';
import { TuiAvatar } from '@taiga-ui/kit/components/avatar';
import { TuiCell } from '@taiga-ui/layout/components/cell';
import { TUI_INPUT_SEARCH } from '@taiga-ui/layout/tokens';
import { map, filter } from 'rxjs';
import { tuiCreateOptions } from '@taiga-ui/cdk/utils/di';
import { TuiInputSearch } from '@taiga-ui/layout/components/input-search';
import { __decorate } from 'tslib';
import { TuiLet } from '@taiga-ui/cdk/directives/let';
import { TuiFilterPipe } from '@taiga-ui/cdk/pipes/filter';
import { tuiInjectElement } from '@taiga-ui/cdk/utils/dom';
import { tuiMoveFocus } from '@taiga-ui/cdk/utils/focus';
import { tuiClamp } from '@taiga-ui/cdk/utils/math';
import { tuiPure } from '@taiga-ui/cdk/utils/miscellaneous';
import { TuiIconPipe } from '@taiga-ui/core/components/icon';
import { TuiLoader } from '@taiga-ui/core/components/loader';
import { TuiScrollbar } from '@taiga-ui/core/components/scrollbar';
import * as i2 from '@taiga-ui/kit/components/tabs';
import { TuiTabs } from '@taiga-ui/kit/components/tabs';
import * as i1 from '@taiga-ui/layout/components/block-status';
import { TuiBlockStatus } from '@taiga-ui/layout/components/block-status';

const [TUI_SEARCH_RESULTS_OPTIONS, tuiSearchResultsOptionsProvider] = tuiCreateOptions({
    key: 'taiga-search-history',
    history: '@tui.clock',
    popular: '@tui.search',
    empty: '@tui.search',
    remove: '@tui.trash',
});

class TuiSearchHistory {
    constructor() {
        this.textfield = inject(TuiTextfieldComponent);
        this.storage = inject(WA_LOCAL_STORAGE);
        this.control = inject(NgControl);
        this.close = toSignal(inject(TUI_CLOSE_WORD));
        this.i18n = toSignal(inject(TUI_INPUT_SEARCH));
        this.options = inject(TUI_SEARCH_RESULTS_OPTIONS);
        this.$ = this.control.valueChanges
            ?.pipe(map(String), filter((item) => !!item && !this.popular.includes(item)), takeUntilDestroyed())
            .subscribe((value) => {
            this.store(value);
        });
        this.history = this.items;
        this.popular = [];
    }
    store(item) {
        this.storage?.setItem(this.options.key, JSON.stringify(Array.from(new Set([item.trim(), ...this.items]))
            .filter((v, _, a) => v && !a.find((s) => s.startsWith(v) && s !== v))
            .slice(0, 5)));
    }
    remove(item) {
        this.textfield.input?.nativeElement.focus();
        this.history = this.history.filter((v) => v !== item);
        this.storage?.setItem(this.options.key, JSON.stringify(this.items.filter((v) => v !== item)));
    }
    select(item) {
        this.control.control?.setValue(item);
        this.textfield.input?.nativeElement.focus();
    }
    get items() {
        return JSON.parse(this.storage?.getItem(this.options.key) || '[]');
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchHistory, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiSearchHistory, isStandalone: true, selector: "tui-search-history", inputs: { popular: "popular" }, ngImport: i0, template: "<label\n    *ngIf=\"history.length\"\n    class=\"t-sr-label\"\n>\n    {{ i18n()?.history }}\n</label>\n<button\n    *ngFor=\"let item of history\"\n    tuiCell\n    type=\"button\"\n    (click)=\"select(item)\"\n    (keydown.backspace)=\"remove(item)\"\n    (keydown.delete)=\"remove(item)\"\n    (mousedown.prevent)=\"(0)\"\n>\n    <tui-avatar [src]=\"options.history\" />\n    <span tuiTitle>{{ item }}</span>\n    <button\n        appearance=\"icon\"\n        size=\"xs\"\n        tabindex=\"-1\"\n        tuiIconButton\n        type=\"button\"\n        [iconStart]=\"options.remove\"\n        (click.stop)=\"remove(item)\"\n    >\n        \uD83D\uDDD1\uFE0F\n    </button>\n</button>\n<label\n    *ngIf=\"popular.length\"\n    class=\"t-sr-label\"\n>\n    {{ i18n()?.popular }}\n</label>\n<button\n    *ngFor=\"let item of popular\"\n    tuiCell\n    type=\"button\"\n    (click)=\"select(item)\"\n    (mousedown.prevent)=\"(0)\"\n>\n    <tui-avatar [src]=\"options.popular\" />\n    <span tuiTitle>{{ item }}</span>\n</button>\n", styles: [":host:not(:empty){display:block;padding:.375rem 0}\n"], dependencies: [{ kind: "directive", type: NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: TuiAvatar, selector: "tui-avatar,button[tuiAvatar],a[tuiAvatar]", inputs: ["size", "round", "src"] }, { kind: "directive", type: TuiButton, selector: "a[tuiButton],button[tuiButton],a[tuiIconButton],button[tuiIconButton]", inputs: ["size"] }, { kind: "directive", type: TuiCell, selector: "[tuiCell]:not(ng-template)", inputs: ["tuiCell", "tuiCellHeight"] }, { kind: "directive", type: TuiTitle, selector: "[tuiTitle]", inputs: ["tuiTitle"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchHistory, decorators: [{
            type: Component,
            args: [{ standalone: true, selector: 'tui-search-history', imports: [NgForOf, NgIf, TuiAvatar, TuiButton, TuiCell, TuiTitle], changeDetection: ChangeDetectionStrategy.OnPush, template: "<label\n    *ngIf=\"history.length\"\n    class=\"t-sr-label\"\n>\n    {{ i18n()?.history }}\n</label>\n<button\n    *ngFor=\"let item of history\"\n    tuiCell\n    type=\"button\"\n    (click)=\"select(item)\"\n    (keydown.backspace)=\"remove(item)\"\n    (keydown.delete)=\"remove(item)\"\n    (mousedown.prevent)=\"(0)\"\n>\n    <tui-avatar [src]=\"options.history\" />\n    <span tuiTitle>{{ item }}</span>\n    <button\n        appearance=\"icon\"\n        size=\"xs\"\n        tabindex=\"-1\"\n        tuiIconButton\n        type=\"button\"\n        [iconStart]=\"options.remove\"\n        (click.stop)=\"remove(item)\"\n    >\n        \uD83D\uDDD1\uFE0F\n    </button>\n</button>\n<label\n    *ngIf=\"popular.length\"\n    class=\"t-sr-label\"\n>\n    {{ i18n()?.popular }}\n</label>\n<button\n    *ngFor=\"let item of popular\"\n    tuiCell\n    type=\"button\"\n    (click)=\"select(item)\"\n    (mousedown.prevent)=\"(0)\"\n>\n    <tui-avatar [src]=\"options.popular\" />\n    <span tuiTitle>{{ item }}</span>\n</button>\n", styles: [":host:not(:empty){display:block;padding:.375rem 0}\n"] }]
        }], propDecorators: { popular: [{
                type: Input
            }] } });

class TuiSearchHotkey {
    constructor() {
        this.platform = inject(WA_NAVIGATOR).platform;
        this.search = inject(TuiInputSearch);
        this.placeholder = toSignal(inject(TUI_INPUT_SEARCH).pipe(map(({ hotkey }) => this.platform.startsWith('Mac') ? `⌘+K ${hotkey}` : `Alt+K ${hotkey}`)));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchHotkey, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.2.12", type: TuiSearchHotkey, isStandalone: true, selector: "input[tuiSearchHotkey]", host: { listeners: { "document:keydown.meta.k.stop": "search.open()", "document:keydown.alt.k.stop": "search.open()" }, properties: { "placeholder": "placeholder()" } }, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchHotkey, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: 'input[tuiSearchHotkey]',
                    host: {
                        '[placeholder]': 'placeholder()',
                        '(document:keydown.meta.k.stop)': 'search.open()',
                        '(document:keydown.alt.k.stop)': 'search.open()',
                    },
                }]
        }] });

class TuiSearchResultsComponent {
    constructor() {
        this.el = tuiInjectElement();
        this.options = inject(TUI_SEARCH_RESULTS_OPTIONS);
        this.i18n = toSignal(inject(TUI_INPUT_SEARCH));
        this.textfield = inject(TuiTextfieldComponent);
        this.active = 0;
        this.results = {};
    }
    ngOnChanges() {
        this.active = 0;
    }
    isEmpty(results) {
        return !Object.values(results).reduce((total, { length }) => length + total, 0);
    }
    onArrow(current, step) {
        const elements = Array.from(this.el.querySelectorAll('[tuiCell]'));
        if (elements[0] === current && step < 0) {
            this.textfield.input?.nativeElement.focus();
        }
        else {
            tuiMoveFocus(elements.indexOf(current), elements, step);
        }
    }
    tab(step) {
        const max = Object.values(this.results || {}).filter((v) => v.length).length;
        this.active = tuiClamp(this.active + step, 0, max);
        this.textfield.input?.nativeElement.focus();
    }
    notEmpty({ value }) {
        return !!value.length;
    }
    asIs() {
        return 0;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchResultsComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiSearchResultsComponent, isStandalone: true, selector: "tui-search-results", inputs: { results: "results" }, host: { listeners: { "keydown.arrowDown.prevent": "onArrow($event.target, 1)", "keydown.arrowUp.prevent": "onArrow($event.target, -1)" } }, queries: [{ propertyName: "template", first: true, predicate: TemplateRef, descendants: true }], usesOnChanges: true, ngImport: i0, template: "<ng-content *ngIf=\"!textfield.value(); else a\" />\n<ng-template #a>\n    <tui-loader\n        *ngIf=\"!results; else b\"\n        class=\"t-loader\"\n    />\n    <ng-template #b>\n        <tui-block-status\n            *ngIf=\"results && isEmpty(results); else c\"\n            size=\"m\"\n            class=\"t-status\"\n        >\n            <img\n                alt=\"\"\n                tuiSlot=\"top\"\n                class=\"t-empty\"\n                [src]=\"options.empty | tuiIcon\"\n            />\n            {{ i18n()?.empty }}\n        </tui-block-status>\n        <ng-template #c>\n            <ng-container *tuiLet=\"(results | keyvalue: asIs) || [] as items\">\n                <tui-scrollbar class=\"t-scrollbar\">\n                    <ng-container *ngFor=\"let group of items | tuiFilter: notEmpty; let index = index\">\n                        <ng-container *ngIf=\"!active || active === index + 1\">\n                            <label\n                                *ngIf=\"!active && items.length > 1\"\n                                class=\"t-sr-label\"\n                            >\n                                {{ group.key }}\n                            </label>\n                            <ng-container\n                                *ngFor=\"let item of group.value\"\n                                [ngTemplateOutlet]=\"template || null\"\n                                [ngTemplateOutletContext]=\"{$implicit: item}\"\n                            />\n                        </ng-container>\n                    </ng-container>\n                </tui-scrollbar>\n                <tui-tabs\n                    *ngIf=\"items.length > 1\"\n                    size=\"m\"\n                    class=\"t-tabs\"\n                    [(activeItemIndex)]=\"active\"\n                    (document:keydown.shift.tab.prevent)=\"tab(-1)\"\n                    (document:keydown.tab.prevent)=\"tab(1)\"\n                >\n                    <button tuiTab>{{ i18n()?.all }}</button>\n                    <ng-container *ngFor=\"let group of items\">\n                        <button\n                            *ngIf=\"group.value.length\"\n                            tuiTab\n                        >\n                            {{ group.key }}\n                        </button>\n                    </ng-container>\n                </tui-tabs>\n            </ng-container>\n        </ng-template>\n    </ng-template>\n</ng-template>\n", styles: [":host{display:flex;flex-direction:column;border-radius:var(--tui-radius-l);background:var(--tui-background-base);box-shadow:inset 0 0 0 1px var(--tui-border-normal)}:host ::ng-deep [tuiCell]{inline-size:-webkit-fill-available;inline-size:-moz-available;inline-size:stretch;padding:.375rem;margin:.25rem .625rem;border-radius:var(--tui-radius-l)}:host ::ng-deep [tuiCell]>tui-avatar{border-radius:var(--tui-radius-m)}:host ::ng-deep .t-sr-label{display:block;font:var(--tui-font-text-ui-s);color:var(--tui-text-secondary);margin:.75rem 1rem .5rem}.t-loader{margin:1rem 0}.t-status{margin-block-end:2rem}.t-empty{margin-block-start:1.5rem;filter:invert(1)}.t-tabs{order:-1;margin:0 1rem;box-shadow:none;border-image:linear-gradient(0deg,var(--tui-border-normal) 1px,transparent 0) fill 0/0/0 1rem}.t-tabs:before{background:var(--tui-background-accent-opposite-pressed)}.t-scrollbar{max-block-size:30rem;padding:.375rem 0}\n"], dependencies: [{ kind: "pipe", type: KeyValuePipe, name: "keyvalue" }, { kind: "directive", type: NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "component", type: i1.TuiBlockStatusComponent, selector: "tui-block-status", inputs: ["card", "size"] }, { kind: "directive", type: i1.TuiBlockStatusDirective, selector: "[tuiSlot]", inputs: ["tuiSlot"] }, { kind: "pipe", type: TuiFilterPipe, name: "tuiFilter" }, { kind: "pipe", type: TuiIconPipe, name: "tuiIcon" }, { kind: "directive", type: TuiLet, selector: "[tuiLet]", inputs: ["tuiLet"] }, { kind: "component", type: TuiLoader, selector: "tui-loader", inputs: ["size", "inheritColor", "overlay", "textContent", "showLoader"] }, { kind: "component", type: TuiScrollbar, selector: "tui-scrollbar", inputs: ["hidden"] }, { kind: "directive", type: i2.TuiTab, selector: "a[tuiTab]:not([routerLink]), a[tuiTab][routerLink][routerLinkActive], button[tuiTab]" }, { kind: "directive", type: i2.TuiTabsHorizontal, selector: "tui-tabs:not([vertical]), nav[tuiTabs]:not([vertical])", inputs: ["underline"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
__decorate([
    tuiPure
], TuiSearchResultsComponent.prototype, "isEmpty", null);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiSearchResultsComponent, decorators: [{
            type: Component,
            args: [{ standalone: true, selector: 'tui-search-results', imports: [
                        KeyValuePipe,
                        NgForOf,
                        NgIf,
                        NgTemplateOutlet,
                        TuiBlockStatus,
                        TuiFilterPipe,
                        TuiIconPipe,
                        TuiLet,
                        TuiLoader,
                        TuiScrollbar,
                        TuiTabs,
                    ], changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        '(keydown.arrowDown.prevent)': 'onArrow($event.target, 1)',
                        '(keydown.arrowUp.prevent)': 'onArrow($event.target, -1)',
                    }, template: "<ng-content *ngIf=\"!textfield.value(); else a\" />\n<ng-template #a>\n    <tui-loader\n        *ngIf=\"!results; else b\"\n        class=\"t-loader\"\n    />\n    <ng-template #b>\n        <tui-block-status\n            *ngIf=\"results && isEmpty(results); else c\"\n            size=\"m\"\n            class=\"t-status\"\n        >\n            <img\n                alt=\"\"\n                tuiSlot=\"top\"\n                class=\"t-empty\"\n                [src]=\"options.empty | tuiIcon\"\n            />\n            {{ i18n()?.empty }}\n        </tui-block-status>\n        <ng-template #c>\n            <ng-container *tuiLet=\"(results | keyvalue: asIs) || [] as items\">\n                <tui-scrollbar class=\"t-scrollbar\">\n                    <ng-container *ngFor=\"let group of items | tuiFilter: notEmpty; let index = index\">\n                        <ng-container *ngIf=\"!active || active === index + 1\">\n                            <label\n                                *ngIf=\"!active && items.length > 1\"\n                                class=\"t-sr-label\"\n                            >\n                                {{ group.key }}\n                            </label>\n                            <ng-container\n                                *ngFor=\"let item of group.value\"\n                                [ngTemplateOutlet]=\"template || null\"\n                                [ngTemplateOutletContext]=\"{$implicit: item}\"\n                            />\n                        </ng-container>\n                    </ng-container>\n                </tui-scrollbar>\n                <tui-tabs\n                    *ngIf=\"items.length > 1\"\n                    size=\"m\"\n                    class=\"t-tabs\"\n                    [(activeItemIndex)]=\"active\"\n                    (document:keydown.shift.tab.prevent)=\"tab(-1)\"\n                    (document:keydown.tab.prevent)=\"tab(1)\"\n                >\n                    <button tuiTab>{{ i18n()?.all }}</button>\n                    <ng-container *ngFor=\"let group of items\">\n                        <button\n                            *ngIf=\"group.value.length\"\n                            tuiTab\n                        >\n                            {{ group.key }}\n                        </button>\n                    </ng-container>\n                </tui-tabs>\n            </ng-container>\n        </ng-template>\n    </ng-template>\n</ng-template>\n", styles: [":host{display:flex;flex-direction:column;border-radius:var(--tui-radius-l);background:var(--tui-background-base);box-shadow:inset 0 0 0 1px var(--tui-border-normal)}:host ::ng-deep [tuiCell]{inline-size:-webkit-fill-available;inline-size:-moz-available;inline-size:stretch;padding:.375rem;margin:.25rem .625rem;border-radius:var(--tui-radius-l)}:host ::ng-deep [tuiCell]>tui-avatar{border-radius:var(--tui-radius-m)}:host ::ng-deep .t-sr-label{display:block;font:var(--tui-font-text-ui-s);color:var(--tui-text-secondary);margin:.75rem 1rem .5rem}.t-loader{margin:1rem 0}.t-status{margin-block-end:2rem}.t-empty{margin-block-start:1.5rem;filter:invert(1)}.t-tabs{order:-1;margin:0 1rem;box-shadow:none;border-image:linear-gradient(0deg,var(--tui-border-normal) 1px,transparent 0) fill 0/0/0 1rem}.t-tabs:before{background:var(--tui-background-accent-opposite-pressed)}.t-scrollbar{max-block-size:30rem;padding:.375rem 0}\n"] }]
        }], propDecorators: { template: [{
                type: ContentChild,
                args: [TemplateRef]
            }], results: [{
                type: Input
            }], isEmpty: [] } });

const TuiSearchResults = [
    TuiSearchHotkey,
    TuiSearchHistory,
    TuiSearchResultsComponent,
];

/**
 * Generated bundle index. Do not edit.
 */

export { TUI_SEARCH_RESULTS_OPTIONS, TuiSearchHistory, TuiSearchHotkey, TuiSearchResults, TuiSearchResultsComponent, tuiSearchResultsOptionsProvider };
//# sourceMappingURL=taiga-ui-experimental-components-search-results.mjs.map
