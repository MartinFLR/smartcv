import { DOCUMENT } from '@angular/common';
import { ElementRef, forwardRef, NgZone } from '@angular/core';
import { TUI_FALSE_HANDLER, TUI_TRUE_HANDLER } from '@taiga-ui/cdk/constants';
import { tuiTypedFromEvent, tuiZonefree } from '@taiga-ui/cdk/observables';
import { TUI_IS_IOS } from '@taiga-ui/cdk/tokens';
import { tuiProvide } from '@taiga-ui/cdk/utils/miscellaneous';
import { TUI_SCROLL_REF } from '@taiga-ui/core/tokens';
import { concat, delay, map, merge, share, switchMap, take, takeUntil, zip, } from 'rxjs';
import { TUI_SHEET, TUI_SHEET_DRAGGED, TUI_SHEET_SCROLL } from '../../sheet-tokens';
import { TuiSheetComponent } from './sheet.component';
export const TUI_SHEET_PROVIDERS = [
    {
        provide: TUI_SHEET_DRAGGED,
        deps: [ElementRef],
        useFactory: ({ nativeElement }) => merge(tuiTypedFromEvent(nativeElement, 'touchstart', { passive: true }).pipe(map(TUI_TRUE_HANDLER)), tuiTypedFromEvent(nativeElement, 'touchend').pipe(map(TUI_FALSE_HANDLER))),
    },
    {
        provide: TUI_SHEET_SCROLL,
        deps: [ElementRef, NgZone, DOCUMENT, TUI_IS_IOS],
        useFactory: ({ nativeElement }, zone, doc, isIos) => isIos
            ? iosScrollFactory(nativeElement, doc, zone)
            : merge(tuiTypedFromEvent(nativeElement, 'scroll'), tuiTypedFromEvent(nativeElement, 'load', { capture: true })).pipe(map(() => nativeElement.scrollTop), tuiZonefree(zone), share()),
    },
    tuiProvide(TUI_SCROLL_REF, ElementRef),
    tuiProvide(TUI_SHEET, forwardRef(() => TuiSheetComponent)),
];
function iosScrollFactory(element, doc, zone) {
    const load$ = tuiTypedFromEvent(element, 'load', { capture: true });
    const touchstart$ = tuiTypedFromEvent(element, 'touchstart', { passive: true });
    const touchmove$ = tuiTypedFromEvent(doc, 'touchmove', { passive: true });
    const touchend$ = tuiTypedFromEvent(doc, 'touchend');
    const scroll$ = tuiTypedFromEvent(element, 'scroll').pipe(map(() => element.scrollTop));
    const result$ = merge(load$.pipe(delay(0), map(() => element.scrollTop)), touchstart$.pipe(switchMap(({ touches }) => {
        const { screenY = 0 } = touches[0] ?? {};
        const { scrollTop } = element;
        return concat(
        // Sometimes touch is triggered without scroll in iOS, filter that
        zip(touchmove$, scroll$).pipe(map(([{ touches }]) => scrollTop + screenY - (touches[0]?.screenY ?? 0)), takeUntil(touchend$)), scroll$);
    })));
    return concat(scroll$.pipe(take(1)), result$).pipe(tuiZonefree(zone), share());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlZXQucHJvdmlkZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGVnYWN5L2NvbXBvbmVudHMvc2hlZXQvY29tcG9uZW50cy9zaGVldC9zaGVldC5wcm92aWRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDNUUsT0FBTyxFQUFDLGlCQUFpQixFQUFFLGdCQUFnQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDNUUsT0FBTyxFQUFDLGlCQUFpQixFQUFFLFdBQVcsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ3pFLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFDN0QsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBQ3JELE9BQU8sRUFDSCxNQUFNLEVBQ04sS0FBSyxFQUNMLEdBQUcsRUFDSCxLQUFLLEVBRUwsS0FBSyxFQUNMLFNBQVMsRUFDVCxJQUFJLEVBQ0osU0FBUyxFQUNULEdBQUcsR0FDTixNQUFNLE1BQU0sQ0FBQztBQUVkLE9BQU8sRUFBQyxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRixPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUVwRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBZTtJQUMzQztRQUNJLE9BQU8sRUFBRSxpQkFBaUI7UUFDMUIsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDO1FBQ2xCLFVBQVUsRUFBRSxDQUFDLEVBQUMsYUFBYSxFQUEwQixFQUF1QixFQUFF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SUFBSSxDQUFDLENBQUMsQ0FDdkQsRUFDRCxTQUFTLENBQUMsU0FBUyxDQUFDLENBQ3ZCLEVBQ0QsT0FBTyxDQUNWLENBQUM7SUFDTixDQUFDLENBQUMsQ0FDTCxDQUNKLENBQUM7SUFFRixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUNuRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtET0NVTUVOVH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7RWxlbWVudFJlZiwgZm9yd2FyZFJlZiwgTmdab25lLCB0eXBlIFByb3ZpZGVyfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7VFVJX0ZBTFNFX0hBTkRMRVIsIFRVSV9UUlVFX0hBTkRMRVJ9IGZyb20gJ0B0YWlnYS11aS9jZGsvY29uc3RhbnRzJztcbmltcG9ydCB7dHVpVHlwZWRGcm9tRXZlbnQsIHR1aVpvbmVmcmVlfSBmcm9tICdAdGFpZ2EtdWkvY2RrL29ic2VydmFibGVzJztcbmltcG9ydCB7VFVJX0lTX0lPU30gZnJvbSAnQHRhaWdhLXVpL2Nkay90b2tlbnMnO1xuaW1wb3J0IHt0dWlQcm92aWRlfSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL21pc2NlbGxhbmVvdXMnO1xuaW1wb3J0IHtUVUlfU0NST0xMX1JFRn0gZnJvbSAnQHRhaWdhLXVpL2NvcmUvdG9rZW5zJztcbmltcG9ydCB7XG4gICAgY29uY2F0LFxuICAgIGRlbGF5LFxuICAgIG1hcCxcbiAgICBtZXJnZSxcbiAgICB0eXBlIE9ic2VydmFibGUsXG4gICAgc2hhcmUsXG4gICAgc3dpdGNoTWFwLFxuICAgIHRha2UsXG4gICAgdGFrZVVudGlsLFxuICAgIHppcCxcbn0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7VFVJX1NIRUVULCBUVUlfU0hFRVRfRFJBR0dFRCwgVFVJX1NIRUVUX1NDUk9MTH0gZnJvbSAnLi4vLi4vc2hlZXQtdG9rZW5zJztcbmltcG9ydCB7VHVpU2hlZXRDb21wb25lbnR9IGZyb20gJy4vc2hlZXQuY29tcG9uZW50JztcblxuZXhwb3J0IGNvbnN0IFRVSV9TSEVFVF9QUk9WSURFUlM6IFByb3ZpZGVyW10gPSBbXG4gICAge1xuICAgICAgICBwcm92aWRlOiBUVUlfU0hFRVRfRFJBR0dFRCxcbiAgICAgICAgZGVwczogW0VsZW1lbnRSZWZdLFxuICAgICAgICB1c2VGYWN0b3J5OiAoe25hdGl2ZUVsZW1lbnR9OiBFbGVtZW50UmVmPEhUTUxFbGVtZW50Pik6IE9ic2VydmFibGU8Ym9vbGVhbj4gPT5cbiAgICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgICAgIHR1aVR5cGVkRnJvbUV2ZW50KG5hdGl2ZUVsZW1lbnQsICd0b3VjaHN0YXJ0Jywge3Bhc3NpdmU6IHRydWV9KS5waXBlKFxuICAgICAgICAgICAgICAgICAgICBtYXAoVFVJX1RSVUVfSEFORExFUiksXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0dWlUeXBlZEZyb21FdmVudChuYXRpdmVFbGVtZW50LCAndG91Y2hlbmQnKS5waXBlKG1hcChUVUlfRkFMU0VfSEFORExFUikpLFxuICAgICAgICAgICAgKSxcbiAgICB9LFxuICAgIHtcbiAgICAgICAgcHJvdmlkZTogVFVJX1NIRUVUX1NDUk9MTCxcbiAgICAgICAgZGVwczogW0VsZW1lbnRSZWYsIE5nWm9uZSwgRE9DVU1FTlQsIFRVSV9JU19JT1NdLFxuICAgICAgICB1c2VGYWN0b3J5OiAoXG4gICAgICAgICAgICB7bmF0aXZlRWxlbWVudH06IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+LFxuICAgICAgICAgICAgem9uZTogTmdab25lLFxuICAgICAgICAgICAgZG9jOiBEb2N1bWVudCxcbiAgICAgICAgICAgIGlzSW9zOiBib29sZWFuLFxuICAgICAgICApOiBPYnNlcnZhYmxlPG51bWJlcj4gPT5cbiAgICAgICAgICAgIGlzSW9zXG4gICAgICAgICAgICAgICAgPyBpb3NTY3JvbGxGYWN0b3J5KG5hdGl2ZUVsZW1lbnQsIGRvYywgem9uZSlcbiAgICAgICAgICAgICAgICA6IG1lcmdlKFxuICAgICAgICAgICAgICAgICAgICAgIHR1aVR5cGVkRnJvbUV2ZW50KG5hdGl2ZUVsZW1lbnQsICdzY3JvbGwnKSxcbiAgICAgICAgICAgICAgICAgICAgICB0dWlUeXBlZEZyb21FdmVudChuYXRpdmVFbGVtZW50LCAnbG9hZCcsIHtjYXB0dXJlOiB0cnVlfSksXG4gICAgICAgICAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+IG5hdGl2ZUVsZW1lbnQuc2Nyb2xsVG9wKSxcbiAgICAgICAgICAgICAgICAgICAgICB0dWlab25lZnJlZSh6b25lKSxcbiAgICAgICAgICAgICAgICAgICAgICBzaGFyZSgpLFxuICAgICAgICAgICAgICAgICAgKSxcbiAgICB9LFxuICAgIHR1aVByb3ZpZGUoVFVJX1NDUk9MTF9SRUYsIEVsZW1lbnRSZWYpLFxuICAgIHR1aVByb3ZpZGUoXG4gICAgICAgIFRVSV9TSEVFVCxcbiAgICAgICAgZm9yd2FyZFJlZigoKSA9PiBUdWlTaGVldENvbXBvbmVudCksXG4gICAgKSxcbl07XG5cbmZ1bmN0aW9uIGlvc1Njcm9sbEZhY3RvcnkoXG4gICAgZWxlbWVudDogSFRNTEVsZW1lbnQsXG4gICAgZG9jOiBEb2N1bWVudCxcbiAgICB6b25lOiBOZ1pvbmUsXG4pOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIGNvbnN0IGxvYWQkID0gdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ2xvYWQnLCB7Y2FwdHVyZTogdHJ1ZX0pO1xuICAgIGNvbnN0IHRvdWNoc3RhcnQkID0gdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ3RvdWNoc3RhcnQnLCB7cGFzc2l2ZTogdHJ1ZX0pO1xuICAgIGNvbnN0IHRvdWNobW92ZSQgPSB0dWlUeXBlZEZyb21FdmVudChkb2MsICd0b3VjaG1vdmUnLCB7cGFzc2l2ZTogdHJ1ZX0pO1xuICAgIGNvbnN0IHRvdWNoZW5kJCA9IHR1aVR5cGVkRnJvbUV2ZW50KGRvYywgJ3RvdWNoZW5kJyk7XG4gICAgY29uc3Qgc2Nyb2xsJCA9IHR1aVR5cGVkRnJvbUV2ZW50KGVsZW1lbnQsICdzY3JvbGwnKS5waXBlKFxuICAgICAgICBtYXAoKCkgPT4gZWxlbWVudC5zY3JvbGxUb3ApLFxuICAgICk7XG4gICAgY29uc3QgcmVzdWx0JCA9IG1lcmdlKFxuICAgICAgICBsb2FkJC5waXBlKFxuICAgICAgICAgICAgZGVsYXkoMCksXG4gICAgICAgICAgICBtYXAoKCkgPT4gZWxlbWVudC5zY3JvbGxUb3ApLFxuICAgICAgICApLFxuICAgICAgICB0b3VjaHN0YXJ0JC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCh7dG91Y2hlc30pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7c2NyZWVuWSA9IDB9ID0gdG91Y2hlc1swXSA/PyB7fTtcbiAgICAgICAgICAgICAgICBjb25zdCB7c2Nyb2xsVG9wfSA9IGVsZW1lbnQ7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICAvLyBTb21ldGltZXMgdG91Y2ggaXMgdHJpZ2dlcmVkIHdpdGhvdXQgc2Nyb2xsIGluIGlPUywgZmlsdGVyIHRoYXRcbiAgICAgICAgICAgICAgICAgICAgemlwKHRvdWNobW92ZSQsIHNjcm9sbCQpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKFt7dG91Y2hlc31dKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb3AgKyBzY3JlZW5ZIC0gKHRvdWNoZXNbMF0/LnNjcmVlblkgPz8gMCksXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFrZVVudGlsKHRvdWNoZW5kJCksXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbCQsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICApLFxuICAgICk7XG5cbiAgICByZXR1cm4gY29uY2F0KHNjcm9sbCQucGlwZSh0YWtlKDEpKSwgcmVzdWx0JCkucGlwZSh0dWlab25lZnJlZSh6b25lKSwgc2hhcmUoKSk7XG59XG4iXX0=