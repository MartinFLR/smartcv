<ng-container *transloco="let t">
  <fieldset class="contents">
    <header class="flex flex-col gap-1 border-b border-[var(--tui-border-normal)] pb-4 -mt-4">
      <h2
        class="text-xl md:text-2xl font-bold text-[var(--tui-text-primary)] flex items-center gap-2"
      >
        <tui-icon icon="@tui.code" class="text-[var(--tui-text-action)] size-6"></tui-icon>
        {{ t('cv.skills.title') }}
      </h2>
      <p class="text-[var(--tui-text-secondary)] text-base leading-snug">
        {{ t('cv.skills.subtitle') }}
      </p>
    </header>

    @for (skillGroup of service.formArray().controls; track $index; let i = $index) {
      <div [formGroup]="skillGroup" class="rounded-2xl flex flex-col gap-6 mt-4 mb-6">
        <tui-textfield multi iconStart="@tui.code">
          <label tuiLabel for="skillsSkills">{{ t('cv.skills.skill.name') }}</label>
          <input
            tuiInputChip
            formControlName="skills"
            [placeholder]="t('cv.skills.skill.placeholder')"
            id="skillsSkills"
          />
          <tui-input-chip *tuiItem></tui-input-chip>
        </tui-textfield>

        <tui-textfield multi iconStart="@tui.languages">
          <label tuiLabel for="skillsLanguages">{{ t('cv.skills.language.name') }}</label>
          <input
            tuiInputChip
            formControlName="languages"
            [placeholder]="t('cv.skills.language.placeholder')"
            id="skillsLanguages"
          />
          <tui-input-chip *tuiItem></tui-input-chip>
        </tui-textfield>

        <div class="flex flex-col gap-3">
          <h3 class="text-lg font-semibold flex items-center gap-2">
            <tui-icon icon="@tui.award" class="text-[var(--tui-text-secondary)]"></tui-icon>
            {{ t('cv.skills.certifications.title') }}
          </h3>

          @if (service.getCertificationsControls(skillGroup).length === 0) {
            <p class="text-sm opacity-60 italic pl-1">
              {{ t('cv.skills.certifications.subtitle') }}
            </p>
          }

          <tui-accordion [closeOthers]="true" class="flex flex-col">
            @for (
              certGroup of service.getCertificationsControls(skillGroup);
              track $index;
              let certIndex = $index
            ) {
              <ng-container>
                <button
                  tuiAccordion
                  type="button"
                  class="w-full flex items-center justify-between p-4 text-left shadow-sm relative z-10 group rounded-xl bg-[var(--tui-background-base)] border border-[var(--tui-border-normal)] hover:border-[var(--tui-border-hover)] transition-colors"
                >
                  <div class="flex items-center overflow-hidden flex-grow">
                    <div
                      class="size-10 rounded-full flex items-center justify-center shrink-0 bg-[var(--tui-background-neutral-1)] text-[var(--tui-text-primary)]"
                    >
                      <tui-icon icon="@tui.stamp" class="text-lg"></tui-icon>
                    </div>

                    <div class="flex flex-col truncate ml-4">
                      <span class="font-bold text-base truncate text-[var(--tui-text-primary)]">
                        {{
                          certGroup.get('name')?.value ||
                            t('cv.skills.certifications.certification.name.placeholder')
                        }}
                      </span>
                      <div class="text-sm flex items-center gap-2 truncate opacity-70">
                        <span class="truncate">
                          {{
                            certGroup.get('date')?.value ||
                              t('cv.skills.certifications.certification.date.placeholder')
                          }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="flex-shrink-0 ml-4 relative z-20 flex items-center gap-2">
                    <button
                      tuiButton
                      type="button"
                      tuiRipple
                      appearance="flat-destructive"
                      size="s"
                      iconStart="@tui.trash"
                      (click)="$event.stopPropagation(); service.removeCertification(i, certIndex)"
                      class="opacity-70 hover:opacity-100 transition-opacity"
                    >
                      <span class="sr-only">Eliminar Certificado</span>
                    </button>
                  </div>
                </button>

                <tui-expand class="w-full">
                  <div class="p-4 pt-2 rounded-b-xl relative top-[-5px]">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4" [formGroup]="certGroup">
                      <div class="md:col-span-8">
                        <tui-textfield class="!min-h-0">
                          <label tuiLabel for="skillsCertificationName">
                            {{ t('cv.skills.certifications.certification.name.name') }}
                          </label>
                          <input
                            tuiTextfield
                            formControlName="name"
                            [placeholder]="
                              t('cv.skills.certifications.certification.name.placeholder')
                            "
                            id="skillsCertificationName"
                          />
                        </tui-textfield>
                      </div>

                      <div class="md:col-span-4">
                        <tui-textfield class="!min-h-0" iconStart="@tui.calendar">
                          <label tuiLabel for="skillsCertificationDate">
                            {{ t('cv.skills.certifications.certification.date.name') }}
                          </label>
                          <input
                            tuiTextfield
                            formControlName="date"
                            [placeholder]="
                              t('cv.skills.certifications.certification.date.placeholder')
                            "
                            id="skillsCertificationDate"
                          />
                        </tui-textfield>
                      </div>
                    </div>
                  </div>
                </tui-expand>
              </ng-container>
            }

            <button
              tuiButton
              type="button"
              size="m"
              tuiRipple
              appearance="secondary"
              class="w-full border-2 border-dashed mt-2 transition-all flex justify-center items-center gap-2 py-3 rounded-xl opacity-70 hover:opacity-100 hover:border-[var(--tui-border-active)]"
              (click)="service.addCertification(i)"
            >
              <tui-icon icon="@tui.plus" class="text-lg"></tui-icon>
              <span class="font-medium">{{ t('cv.skills.certifications.button') }}</span>
            </button>
          </tui-accordion>
        </div>

        <tui-textfield multi class="mt-2" iconStart="@tui.list-plus">
          <label tuiLabel for="skillsAdditional">
            {{ t('cv.skills.additional.name') }}
          </label>
          <input
            tuiInputChip
            formControlName="additional"
            [placeholder]="t('cv.skills.additional.placeholder')"
            id="skillsAdditional"
          />
          <tui-input-chip *tuiItem></tui-input-chip>
        </tui-textfield>
      </div>
    }
  </fieldset>
</ng-container>
