<ng-container *transloco="let t">
  <div [formGroup]="service.iaForm" class="flex flex-col gap-6">
    <header class="flex flex-col gap-1 border-b border-[var(--tui-border-normal)] pb-4 -mt-4">
      <h2
        class="text-xl md:text-2xl font-bold text-[var(--tui-text-primary)] flex items-center gap-2"
      >
        <tui-icon icon="@tui.code" class="text-[var(--tui-text-action)] size-6"></tui-icon>
        {{ t('cv.ats.title') }}
      </h2>
      <p class="text-[var(--tui-text-secondary)] text-base leading-snug">
        {{ t('cv.ats.subtitle') }}
      </p>
    </header>

    @if (!service.fileControl.value) {
      <label for="inputFiles" tuiInputFiles class="block">
        <input
          tuiInputFiles
          accept="application/pdf"
          id="inputFiles"
          [formControl]="service.fileControl"
        />
      </label>
    }

    <tui-files class="tui-space_top-1">
      @if (
        service.fileControl.value | tuiFileRejected: { accept: 'application/pdf' } | async;
        as file
      ) {
        <tui-file state="error" [file]="file" (remove)="service.removeFile()" />
      }
      @if (service.loadedFiles$ | async; as file) {
        <tui-file [file]="file" (remove)="service.removeFile()" />
      }
      @if (service.failedFiles$ | async; as file) {
        <tui-file state="error" [file]="file" (remove)="service.removeFile()" />
      }
    </tui-files>

    <div class="relative flex flex-col gap-4">
      <tui-textfield>
        <label tuiLabel for="jobDescriptionInput">
          {{ t('cv.ia.job.name') }}
        </label>
        <textarea
          tuiTextarea
          [min]="8"
          [max]="10"
          formControlName="jobDescription"
          id="jobDescriptionInput"
        ></textarea>
      </tui-textfield>

      <button
        tuiButton
        type="button"
        class="w-full pt-2 sm:w-auto"
        [loading]="service.isLoading()"
        [disabled]="service.iaForm.invalid || service.isLoading()"
        (click)="service.calculateAtsScore()"
      >
        {{ t('cv.ats.button') }}
        <tui-icon icon="@tui.wand-2" class="ml-2"></tui-icon>
      </button>
    </div>
  </div>

  @if (!service.isLoading() && service.response(); as res) {
    <div class="mt-8 flex flex-col gap-6">
      <div
        tuiCardLarge
        class="relative p-6 border mt-6 border-gray-200 rounded-lg flex flex-col !items-center !justify-center gap-4"
      >
        <h3 class="text-lg font-medium">{{ t('cv.ats.points.title') }}</h3>

        <div class="relative w-32 h-32 flex items-center justify-center">
          <tui-progress-circle
            [color]="service.fitLevelColor()"
            [value]="service.score() ?? 0"
            [max]="100"
            size="xl"
          >
          </tui-progress-circle>

          <div class="absolute flex flex-col items-center justify-center">
            <span class="text-3xl font-bold" [style.color]="service.fitLevelColor()">
              {{ service.scoreText() }}
              @if (service.score() !== null) {
                <span class="text-xl">%</span>
              }
            </span>
          </div>
        </div>

        @if (!service.isLoading()) {
          <p class="text-sm text-center h-5">
            @if (service.score() === null) {
              {{ t('cv.ats.points.level.placeholder') }}
            } @else if (service.score()! < 50) {
              {{ t('cv.ats.points.level.low.description') }}
            } @else if (service.score()! < 80) {
              {{ t('cv.ats.points.level.medium.description') }}
            } @else {
              {{ t('cv.ats.points.level.high.description') }}
            }
          </p>
        }
      </div>

      <div class="flex flex-wrap items-start gap-4">
        <div class="flex flex-col gap-2">
          <h4 class="text-base font-semibold">{{ t('cv.ats.points.level.title') }}</h4>

          <tui-chip
            [style.background-color]="service.fitLevelColor()"
            [style.color]="service.fitLevelTextColor()"
            size="m"
            class="font-medium"
          >
            {{ t(service.fitLevelTranslationKey()) }}
          </tui-chip>
        </div>

        @if (service.warnings().length > 0) {
          <div class="flex-1 min-w-[250px]">
            <tui-notification
              appearance="warning"
              icon="@tui.alert-triangle"
              size="m"
              class="w-full"
            >
              <h5 class="font-semibold mb-1">{{ t('cv.ats.points.level.warning') }}</h5>
              <ul class="list-disc list-inside text-sm">
                @for (warning of service.warnings(); track $index) {
                  <li>{{ warning }}</li>
                }
              </ul>
            </tui-notification>
          </div>
        }
      </div>

      <div>
        <h2 class="text-base font-semibold">{{ t('cv.ats.general') }}</h2>
        <p>{{ service.generalText() }}</p>
      </div>

      <div class="flex flex-col gap-2">
        <h4 class="text-base font-semibold">{{ t('cv.ats.analysis') }}</h4>
        <div tuiItemGroup class="flex flex-wrap gap-2">
          @for (keyword of service.matchedKeywords(); track keyword) {
            <tui-chip appearance="positive" iconStart="@tui.check">{{ keyword }}</tui-chip>
          }
          @for (keyword of service.missingKeywords(); track keyword) {
            <tui-chip appearance="neutral" iconStart="@tui.x">{{ keyword }}</tui-chip>
          }
        </div>
        @if (service.matchedKeywords().length === 0 && service.missingKeywords().length === 0) {
          <p class="text-sm">No se extrajeron palabras clave.</p>
        }
      </div>

      <h4 class="text-base font-semibold">{{ t('cv.ats.sections.title') }}</h4>
      <div class="flex flex-col gap-3">
        @for (section of service.analyzedSections(); track section.name) {
          <div
            class="flex flex-col"
            tuiCardLarge
            tuiSurface="floating"
            [style.background-color]="'var(--tui-background-base-alt)'"
          >
            <div class="text-2xs font-medium capitalize mb-1">
              {{ t(section.translationKey) }}
              <span class="font-bold ml-2">{{ section.score }}%</span>
            </div>

            <progress tuiProgressBar [value]="section.score" [max]="100" class="w-full"></progress>

            <div class="mt-2 text-xs space-y-1">
              @for (highlight of section.analysis.highlights; track $index) {
                <div class="flex items-start">
                  <tui-icon
                    icon="@tui.check"
                    [style.font-size.rem]="1"
                    [style.color]="'var(--tui-status-positive)'"
                    class="mr-1"
                  ></tui-icon>
                  <span [style.color]="'var(--tui-status-positive)'" class="text-sm">{{
                    highlight
                  }}</span>
                </div>
              }
              @for (issue of section.analysis.issues; track $index) {
                <div class="flex items-start">
                  <tui-icon
                    icon="@tui.alert-circle"
                    [style.font-size.rem]="1"
                    [style.color]="'var(--tui-status-warning)'"
                    class="mr-1"
                  ></tui-icon>
                  <span [style.color]="'var(--tui-status-warning)'" class="text-sm">{{
                    issue
                  }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <div class="flex flex-col gap-2">
        <h4 class="text-base font-semibold">{{ t('cv.ats.recommendations') }}</h4>
        <tui-notification appearance="info" icon="@tui.info">
          <ul class="list-disc list-inside text-sm flex flex-col gap-1">
            @for (rec of service.recommendations(); track $index) {
              <li>{{ rec }}</li>
            }
          </ul>
        </tui-notification>
      </div>
    </div>
  }
</ng-container>
