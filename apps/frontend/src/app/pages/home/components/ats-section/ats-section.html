<div [formGroup]="iaForm()" class="flex flex-col gap-6">
  <h2 class="text-xl font-semibold text-gray-800">ATS Checker</h2>

  <div class="p-4 border border-gray-200 rounded relative flex flex-col gap-4 bg-gray-50">
    <tui-textfield>
      <label tuiLabel [for]="'jobDescriptionInput'"
        >Pegá acá la descripción del puesto (Job Description)</label
      >
      <textarea
        tuiTextarea
        formControlName="jobDescription"
        [min]="8"
        [max]="10"
        [id]="'jobDescriptionInput'"
      ></textarea>
    </tui-textfield>
    <div class="text-sm text-gray-600 mt-2">
      <p>
        Pegá la descripción del puesto acá para que la IA pueda comparar tu CV con los requisitos y
        habilidades clave de la oferta.
      </p>
      <p class="mt-1 font-medium">
        Esto permite calcular tu puntaje de compatibilidad ATS y detectar palabras clave faltantes o
        coincidencias importantes.
      </p>
    </div>
  </div>

  <div tuiLabel class="text-sm font-medium text-gray-700">Subí tu CV (formato PDF)</div>
  @if (!control.value) {
    <label [for]="'inputFiles'" tuiInputFiles class="block">
      <input tuiInputFiles accept="application/pdf" [id]="'inputFiles'" [formControl]="control" />
    </label>
  }

  <tui-files class="tui-space_top-1">
    @if (control.value | tuiFileRejected: { accept: 'application/pdf' } | async; as file) {
      <tui-file state="error" [file]="file" (remove)="removeFile()" />
    }
    @if (loadedFiles$ | async; as file) {
      <tui-file [file]="file" (remove)="removeFile()" />
    }
    @if (failedFiles$ | async; as file) {
      <tui-file state="error" [file]="file" (remove)="removeFile()" />
    }
  </tui-files>
</div>
<div
  class="relative p-6 border border-gray-200 rounded-lg bg-gray-50 flex flex-col items-center justify-center gap-4"
  tuiHint="Este es tu puntaje de compatibilidad (ATS) estimado con la descripción del puesto."
>
  <h3 class="text-lg font-medium text-gray-700">Puntaje ATS</h3>

  <div class="relative w-32 h-32 flex items-center justify-center">
    <tui-progress-circle [color]="scoreColor()" [value]="score() ?? 0" [max]="100" size="xl">
    </tui-progress-circle>

    <div class="absolute flex flex-col items-center justify-center">
      <span class="text-3xl font-bold" [style.color]="scoreColor()">
        {{ scoreText() }}
        @if (score() !== null) {
          <span class="text-xl">%</span>
        }
      </span>
    </div>
  </div>

  @if (!isLoading()) {
    <p class="text-sm text-gray-600 text-center h-5">
      @if (score() === null) {
        Subí tu CV y la descripción para ver tu puntaje.
      } @else if (score()! < 50) {
        Necesita mejoras.
      } @else if (score()! < 80) {
        Buen puntaje.
      } @else {
        ¡Excelente compatibilidad!
      }
    </p>
  }

  <button
    tuiButton
    type="button"
    class="w-full sm:w-auto"
    [loading]="isLoading()"
    [disabled]="iaForm().invalid || isLoading()"
    (click)="calculateAtsScore()"
  >
    Calcular Puntaje ATS
  </button>
</div>

@if (!isLoading() && response(); as res) {
  <div class="mt-8 flex flex-col gap-6">
    <div class="flex flex-wrap items-start gap-4">
      <div class="flex flex-col gap-2">
        <h4 class="text-base font-semibold text-gray-800">Nivel de Coincidencia</h4>
        <tui-chip
          [style.background-color]="fitLevelColor()"
          [style.color]="
            fitLevel() === 'Medium'
              ? 'var(--tui-text-primary)'
              : 'var(--tui-text-primary-on-accent)'
          "
          size="m"
          class="font-medium"
        >
          {{ fitLevel() }}
        </tui-chip>
      </div>

      @if (warnings().length > 0) {
        <div class="flex-1 min-w-[250px]">
          <tui-notification appearance="warning" [icon]="'@tui.alert-triangle'" class="w-full">
            <h5 class="font-semibold mb-1">Advertencias</h5>
            <ul class="list-disc list-inside text-sm">
              @for (warning of warnings(); track $index) {
                <li>{{ warning }}</li>
              }
            </ul>
          </tui-notification>
        </div>
      }
    </div>
    <div>
      <h2 class="text-base font-semibold text-gray-800">Vision General</h2>
      <p>{{ generalText() }}</p>
    </div>

    <div class="flex flex-col gap-2">
      <h4 class="text-base font-semibold text-gray-800">Análisis de Palabras Clave</h4>
      <div tuiItemGroup class="flex flex-wrap gap-2">
        @for (keyword of matchedKeywords(); track keyword) {
          <tui-chip appearance="positive" [iconStart]="'@tui.check'">{{ keyword }}</tui-chip>
        }
        @for (keyword of missingKeywords(); track keyword) {
          <tui-chip appearance="neutral" [iconStart]="'@tui.x'">{{ keyword }}</tui-chip>
        }
      </div>
      @if (matchedKeywords().length === 0 && missingKeywords().length === 0) {
        <p class="text-sm text-gray-500">No se extrajeron palabras clave.</p>
      }
    </div>

    <div class="flex flex-col gap-3">
      <h4 class="text-base font-semibold text-gray-800">Puntaje por Sección</h4>

      @for (section of analyzedSections(); track section.name) {
        <div class="flex flex-col">
          <div class="text-sm font-medium text-gray-700 capitalize mb-1">
            {{ section.name | titlecase }}
            <span class="font-bold ml-2">{{ section.score }}%</span>
          </div>

          <progress tuiProgressBar [value]="section.score" [max]="100" class="w-full"></progress>

          <div class="mt-2 text-xs text-gray-600 space-y-1">
            @for (highlight of section.analysis.highlights; track $index) {
              <div class="flex items-start text-green-700">
                <svg class="w-4 h-4 mr-1.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span>{{ highlight }}</span>
              </div>
            }
            @for (issue of section.analysis.issues; track $index) {
              <div class="flex items-start text-red-700">
                <svg class="w-4 h-4 mr-1.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span>{{ issue }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <div class="flex flex-col gap-2">
      <h4 class="text-base font-semibold text-gray-800">Recomendaciones</h4>
      <tui-notification appearance="info" [icon]="'@tui.info'">
        <ul class="list-disc list-inside text-sm flex flex-col gap-1">
          @for (rec of recommendations(); track $index) {
            <li>{{ rec }}</li>
          }
        </ul>
      </tui-notification>
    </div>
  </div>
}
